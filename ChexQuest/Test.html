<html>
  <head>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        overflow: hidden;
      }
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  </head>
  <body>
    <canvas id="gameview"></canvas>
  </body>
  
  <script>
    // State variables
    var fps = 30;
    var animationFrame = 0;
    var prevDirKey = "SHD";
    var dirKey = "SHD"; // Shoot-down
    var ox = 0;
    var oy = 0;
    var px = 0;
    var py = 0;
    var moveDist = 10;
    var fredSrc = "assets/fred.png";

    var fred = new Image();
    fetch("fred.json")
      .then(response => response.json())
      .then(json => {
        fredMap = json;

        // Fred Chexter
        fred.addEventListener(
          "load",
          () => {
            doDraw();
            gameLoop();
          },
          false
        );
        fred.src = fredSrc;
      });

    var keyState = {};    
    window.addEventListener('keydown',function(e){
        keyState[e.keyCode || e.which] = true;
    },true);    
    window.addEventListener('keyup',function(e){
        keyState[e.keyCode || e.which] = false;
    },true);

    // Shamelessly ripped off StackOverflow
    function gameLoop() {
      prevDirKey = dirKey;
      let sx = px;
      let sy = py;
      let key1 = "";
      let key2 = "";
      if (keyState[37] || keyState[65]){
        px -= moveDist;
        key2 = "L";
      }
      if (keyState[38] || keyState[66]){
        py -= moveDist;
        key1 = "U";
      }
      if (keyState[39] || keyState[68]){
        px += moveDist;
        key2 = "R";
      }
      if (keyState[40] || keyState[69]){
        py += moveDist;
        key1 = "D";
      }

      dirKey = key1 + key2 || "SHD";
      //console.log(dirKey);
      if (dirKey == prevDirKey) {
        animationFrame++;
      } else {
        animationFrame = 0;
      }
      requestAnimationFrame(doDraw);

      setTimeout(gameLoop, 1000 / fps);
    }
  
    // Start of game logic
    var gameview = document.getElementById("gameview");
    gameview.width = window.innerWidth;
    gameview.height = window.innerHeight;
    ox = gameview.width / 2;
    oy = gameview.height / 2;

    var ctx = gameview.getContext("2d");
    ctx.mozImageSmoothingEnabled = false;
    ctx.webkitImageSmoothingEnabled = false;
    ctx.msImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false;
    
    // Drawing logic
    function doDraw() {
      // First, clear the screen
      ctx.clearRect(0, 0, gameview.width, gameview.height);

      var w = 60;
      var h = 60;

      // Redraw based on new info
      animationFrame = animationFrame % fredMap[dirKey].length;
      var curFred = fredMap[dirKey][animationFrame];
      var sx = curFred["x1"];
      var sy = curFred["y1"];
      var ex = curFred["x2"];
      var ey = curFred["y2"];
      ctx.drawImage(fred, sx, sy, ex-sx, ey-sy, ox + px, oy + py, w, h);
    }
  </script>
</html>